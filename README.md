## Brain system app

- Проект представляет собой десктопное приложение для проведения игр "Брейн-ринг", "Что-где-когда" и "Эрудитка".
- Десктоп-приложение основано на фреймворке `Qt6` и библиотеке для python `PyQt6`.
- Для игровых  режимов "брейн-ринг" и "эрудитка" необходимо подключение кнопок игроков. В данном проекте предполагается использование контроллера на базе `Arduino Pro Micro`.

Программная часть (десктоп-приложение).

### Локальное развертывание проекта:
1. Версия python: `3.12`, версия poetry:` 2.1.3`.
2. Создать виртуальное окружение и активировать его:
    - `python -m venv venv`;
    - `source venv/bin/activate`.
3. Обновить pip:
    - `pip install --upgrade pip`.
4. Установить poetry:
    - `pip install poetry==2.1.3`.
5. Установить зависимости:
    - `poetry install` (если нужны все зависимости);
    - `poetry install --without dev` (если нужны только основные зависимости).
6. Запустить приложение можно следующей командой:
    - `python main.py`.

### Разработка UI-макетов:
- В системе должны быть глобально установлены `Qt 6 development tools`. Пример для Debian:
    - `apt install qt6-tools-dev-tools`
- Qt designer запускается командой `/usr/lib/qt6/bin/designer`.
- ui-макеты окон расположены в директории `ui/autogenerated` и имеют расширение `.ui`. В этой же директории находятся автоматически сгенерированные ни их основе python-модули.
- Для преобразования ui-инструкции в python-модуль необходимо выполнить команды (отдельно для каждого окна):
    - `pyuic6 ui/autogenerated/main_window.ui -o ui/autogenerated/main_window_autogenerated.py`
    - `pyuic6 ui/autogenerated/brain_ring_game_window.ui -o ui/autogenerated/brain_ring_game_window_autogenerated.py`
    - `pyuic6 ui/autogenerated/www_game_window.ui -o ui/autogenerated/www_game_window_autogenerated.py`
    - `pyuic6 ui/autogenerated/erudite_game_window.ui -o ui/autogenerated/erudite_game_window_autogenerated.py`

### Упаковка приложения в portable-версию:
- Для упаковки приложения используется библиотека `pyinstaller`.
- Сборка portable-версии осуществляется командой:
    - Linux: `pyinstaller main.py --add-data "assets:assets" --add-data "config.ini:."`;
    - Windows: `pyinstaller main.py --noconsole --add-data "assets;assets" --add-data "config.ini;."`.

В этой команде:
- флаг `--noconsole` указывает на то, что при запуске приложения не следует запускать консоль;
- флаг `--add-data` указывает путь хранения дополнительных не бинарных данных (изображений, аудио и файла конфигурации).

Готовая сборка будет находиться в директории `dist`.

Аппаратная часть (контроллер кнопок)


### Принципиальная схема контроллера и печатная плата.

Электрическая схема контроллера находится в директории `heardware/schematics` и представлена в двух форматах:
- `circuit_schema.odg` - для LibreOffice Draw
- `circuit_schema.vsd` - для MS Visio

Ключевые моменты:
- Схема рассчитана на подключение до шести кнопок игроков. Пины подключения к плате Arduino указаны на схеме.
- Для устранения "дребезга" контактов применена схема на основе инвертирующего шестиканального триггера Шмитта.
- Питание платы - внешнее при USB-подключении к хосту.
- Номиналы примененных электронных компонентов указаны на схеме.

Печатная плата, спроектированная на основании принципиальной электрической схемы, находится в директории `hardware/circuit_board`. Открыть файл можно в программе "Sprint Layout" и оттуда же распечатать шаблон для ЛУТ/фоторезиста. Для монтажа микросхем Arduino и триггера используются dip-панели, что обеспечивает возможность быстрой замены микросхем без пайки. Часть электронных компонентов - в smd-исполнении. Типоразмеры и номиналы указаны на схеме.

### Печатные детали

Для сборки брейн-системы используются печатные корпуса и детали. В директории `hardware/printed_parts` находятся модели в формате FreeCAD, оптимизированных под печать на 3D-принтере:
- `arcade_button_based_on_PBS29B.FCStd` - аркадная кнопка на базе стандартной кнопки PBS29B. Состоит из фиксатора и нажимной части. Кнопка PBS29B закрепляется в фиксаторе на защелках и сверху накрывается нажимной частью, которая при нажатии на нее через толкатель замыкает кнопку.
- `player_button_case.FCStd` -  Корпус для размещения аркадной кнопки и присоединения кабеля. Состоит из корпуса и крышки. Отверстия в корпусе для фиксации крышки - под вплавляемые резьбовые втулки M3. Боковое отверстие в корпусе - под гнездо mini-jack 3.5 мм.
- `controller_case.FCStd` -  основной корпус контроллера. Предназначен для размещения печатной платы, подключения кабелей от кнопок, соединения с компьютером. Состоит из крышки и корпуса. Имеется 2 варианта корпуса - для подключения кнопок через RCA- и через mini-jack-гнезда. Для варианта с mini-jack есть модели кружков, которые печатаются в нужном цвете и приклеиваются к корпусу.
- `color_marker_for_mini_jack_plug.FCStd` -  накладка на штекер mini-jack. Может быть распечатана в различных цветах. Надевается на штекер, указывая, к кнопке какого цвета относится данный кабель.

Внимание! В некоторых деталях в отверстиях под крепежные винты есть мембраны, которые сделаны для удобства печати мостов. Впоследствии эти мембраны высверливаются сверлом на 3-3.5 мм.

### Arduino Pro Micro и ее прошивка.
Основном элементом контроллера является плата Arduino Pro Micro. Выбор данной платы обусловлен тем, что в ней использован чип ATmega32u4, который имеет аппаратную поддержку USB 2.0, что позволяет хосту воспринимать контроллер как внешнюю клавиатуру.

Скетч для прошивки платы находится в директории `hardware/arduino_pro_micro_sketch`.

Порядок прошивки платы через Arduino IDE:
1. Открыть скетч `arduino_pro_micro_sketch.ino`;
2. Указать тип платы: Tools -> Boards -> Arduino AVR boards -> Arduino Micro;
3. Указать подключение платы: Tools -> Ports -> Выбрать автоматически определенный порт;
4. Проверить скетч на наличие ошибок (кнопка "verify") (необязательно);
5. Прошить плату (кнопка "upload").

Если во время прошивки произошла ошибка и плата "окирпичилась" (ошибка "the last usb device you connected to this computer malfunctioned"), то восстановить плату можно следующим образом:
1. Соединить пин "RST" через кнопку с "GND" (если плата находится внутри контроллера, то на нем уже есть готовая кнопка "RESET");
2. Открыть диспетчер устройств (device manager), раздел "Ports";
3. Два раза нажать на кнопку "RESET", убедиться, что устройство появляется, через несколько секунд исчезает;
4. Создать максимально простой скетч (или взять любой готовый из Arduino IDE, например "blink");
5. Выбрать плату "Arduino Micro", порт - какой будет предложен;
6. Нажать на кнопу "Upload" и сразу же - 2 раза на кнопку "RESET";
7. После этого плата должна начать снова определяться.


### Legal Info
- Источник векторных изображений для svg-макетов: www.svgrepo.com.
- Источник аудиофайлов: телевизор :tv:
